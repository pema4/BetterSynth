namespace MultimodSynth
{
    /// <summary>
    /// Фильтр низких частот, используемый для понижения частоты дискретизации.
    /// </summary>
    class Downsampler : AudioComponent
    {
        /// <summary>
        /// Коэффициенты, используемые для понижения частоты дискретизации в 2 раза.
        /// </summary>
        public static double[] X2OversamplingCoefficients = new[]
        {
            0.0000030416222567197833,  8.361952157148288e-7,      -0.000005925094515842721,  -0.000003024729165169841,
            0.000009483783706165421,   0.00000723209777116489,    -0.000013294008492742,     -0.000014155214050509543,
            0.000016607882158558667,   0.000024423989868674373,   -0.000018310088319921986,  -0.00003847376842346738,
            0.000016907497464738733,   0.00005639361908773835,    -0.000010563822308760637,  -0.00007776107488778567,
            -0.0000028102981031513762, 0.00010147838274441141,    0.000025404793602647142,   -0.00012562924128648733,
            -0.000059293195541806884,  0.00014737778555502898,    0.00010615545967462068,    -0.0001629327263678661,
            -0.0001669520856300777,    0.00016759863428288119,    0.00024156870266542192,    -0.0001559330731121642,
            -0.00032845768487997786,   0.00012202253220773863,    0.0004243097138152885,     -0.000059881987314738115,
            -0.0005237927446189893,    -0.00003602718887115699,   0.0006193978212302525,     0.00017017774661556506,
            -0.0007014300326804272,    -0.00034528434925108943,   0.000758178232547994,      0.0005615791001342536,
            -0.0007762888215179651,    -0.000816105367898944,     0.0007413571604539623,     0.001102087938453264,
            -0.0006387355546314502,    -0.0014084413464889038,    0.00045454012826587505,    0.0017194776073926833,
            -0.00017682145879295325,   -0.002014868955070687,     -0.00020315303365908512,   0.002269910418084365,
            0.0006895717046618674,     -0.0024561114384577644,    -0.0012807841502350589,    0.0025421258437818978,
            0.001968123259388613,      -0.0024950065823285024,    -0.00273492701557877,      0.0022817470579166617,
            0.0035558350943221766,     -0.0018710464882201244,    -0.004396418860510098,     0.0012352143112775136,
            0.005213177998999048,      -0.00035211017965926044,   -0.005953902083357598,     -0.0007929967550256986,
            0.006558349766125828,      0.0022057713255015233,     -0.006959139407586607,     -0.003881478361851405,
            0.00708266710912906,       0.005804080215017983,      -0.006849758826814975,     -0.007945855701826782,
            0.006175595973442279,      0.010267603871768961,      -0.004968171703644546,     -0.012719463422626474,
            0.0031240124390668894,     0.015242342217107538,      -0.0005188446412763827,    -0.01776991293146465,
            -0.003011419499901605,     0.020231093909868218,      0.007709504147400423,      -0.02255290059398985,
            -0.013980045763524558,     0.02466352548220426,       0.02258557190829597,       -0.02649548534433017,
            -0.03517923749098369,      0.02798866501937985,       0.05611521692777254,       -0.029093088468055358,
            -0.10149581032176695,      0.029771260001166155,      0.31676011963026557,       0.46999907783956496,
            0.31676011963026557,       0.029771260001166155,      -0.10149581032176695,      -0.029093088468055358,
            0.05611521692777254,       0.02798866501937985,       -0.03517923749098369,      -0.02649548534433017,
            0.02258557190829597,       0.02466352548220426,       -0.013980045763524558,     -0.02255290059398985,
            0.007709504147400423,      0.020231093909868218,      -0.003011419499901605,     -0.01776991293146465,
            -0.0005188446412763827,    0.015242342217107538,      0.0031240124390668894,     -0.012719463422626474,
            -0.004968171703644546,     0.010267603871768961,      0.006175595973442279,      -0.007945855701826782,
            -0.006849758826814975,     0.005804080215017983,      0.00708266710912906,       -0.003881478361851405,
            -0.006959139407586607,     0.0022057713255015233,     0.006558349766125828,      -0.0007929967550256986,
            -0.005953902083357598,     -0.00035211017965926044,   0.005213177998999048,      0.0012352143112775136,
            -0.004396418860510098,     -0.0018710464882201244,    0.0035558350943221766,     0.0022817470579166617,
            -0.00273492701557877,      -0.0024950065823285024,    0.001968123259388613,      0.0025421258437818978,
            -0.0012807841502350589,    -0.0024561114384577644,    0.0006895717046618674,     0.002269910418084365,
            -0.00020315303365908512,   -0.002014868955070687,     -0.00017682145879295325,   0.0017194776073926833,
            0.00045454012826587505,    -0.0014084413464889038,    -0.0006387355546314502,    0.001102087938453264,
            0.0007413571604539623,     -0.000816105367898944,     -0.0007762888215179651,    0.0005615791001342536,
            0.000758178232547994,      -0.00034528434925108943,   -0.0007014300326804272,    0.00017017774661556506,
            0.0006193978212302525,     -0.00003602718887115699,   -0.0005237927446189893,    -0.000059881987314738115,
            0.0004243097138152885,     0.00012202253220773863,    -0.00032845768487997786,   -0.0001559330731121642,
            0.00024156870266542192,    0.00016759863428288119,    -0.0001669520856300777,    -0.0001629327263678661,
            0.00010615545967462068,    0.00014737778555502898,    -0.000059293195541806884,  -0.00012562924128648733,
            0.000025404793602647142,   0.00010147838274441141,    -0.0000028102981031513762, -0.00007776107488778567,
            -0.000010563822308760637,  0.00005639361908773835,    0.000016907497464738733,   -0.00003847376842346738,
            -0.000018310088319921986,  0.000024423989868674373,   0.000016607882158558667,   -0.000014155214050509543,
            -0.000013294008492742,     0.00000723209777116489,    0.000009483783706165421,   -0.000003024729165169841,
            -0.000005925094515842721,  8.361952157148288e-7,      0.0000030416222567197833,
        };

        /// <summary>
        /// Коэффициенты, используемые для понижения частоты дискретизации в 4 раза.
        /// </summary>
        public static double[] X4OversamplingCoefficients = new[]
        {
            -2.109927283343053e-7,     -0.0000030954773334054167, -0.000006134974541370354,  -0.000006824726676465002,
            -0.0000029695790184545317, 0.00000543810810444409,    0.000015085719726649097,   0.00002009178690506875,
            0.000014888862902276953,   -0.0000018956441452944518, -0.000024787461023249072,  -0.000042249293152761053,
            -0.0000416318947663319,    -0.000016594762254257985,  0.00002681912949281089,    0.00006964410015600254,
            0.00008706318232532724,    0.00006115720033477816,    -0.000006582162075097628,  -0.00009042562538399676,
            -0.00014823619860910388,   -0.00014085719354295487,   -0.00005496577117692798,   0.0000827605921760652,
            0.00021037372728432093,    0.00025623571397465604,    0.00017610155088211164,    -0.000016263122399402805,
            -0.0002433524664945467,    -0.00039176291740975356,   -0.0003656295979266028,    -0.00014192241084050146,
            0.00020206755938300452,    0.0005095886712000344,     0.0006120209582578663,     0.00041600849812067334,
            -0.00003277867660879936,   -0.0005476637273956544,    -0.0008731935585711394,    -0.0008066909331471724,
            -0.0003136134693221922,    0.00042517940824487083,    0.0010707631209802022,     0.0012756237604383829,
            0.0008623284546548473,     -0.00005709423002142209,   -0.0010927092240135543,    -0.0017338014198887903,
            -0.0015927280535993687,    -0.0006226341547564678,    0.000807278380377599,      0.002038853130332113,
            0.002418742199839844,      0.0016321613448289393,     -0.00008861584485211762,   -0.002005264341221124,
            -0.003177683590299736,     -0.0029126840161716678,    -0.00114846008412864,      0.0014290498189259149,
            0.0036325993682621432,     0.004305916961712298,      0.0029101027553914928,     -0.00012481940224640957,
            -0.003490540750129053,     -0.005544107115204153,     -0.005088839378918694,     -0.002030662129567573,
            0.0024345818096678097,     0.006255154136374177,      0.007439466687422844,      0.005057338890021917,
            -0.0001614091629296627,    -0.005978610069656505,     -0.009567841593976986,     -0.008843251297269953,
            -0.0035915417669226614,    0.004176081095884903,      0.010924281837856691,      0.013137258435477368,
            0.009059066879413208,      -0.00019305987809899484,   -0.010767118715054515,     -0.017568142274464602,
            -0.01656973628096208,      -0.006951764386240666,     0.007978053529804718,      0.021689601418032202,
            0.027009056480791414,      0.019432545209587804,      -0.00021458806269304627,   -0.025044603151207545,
            -0.043883194845277085,     -0.04512703228917539,      -0.02133375728139363,      0.027237558705049188,
            0.09164363867092296,       0.15642955310486548,       0.20434870046124462,       0.22200149201850886,
            0.20434870046124462,       0.15642955310486548,       0.09164363867092296,       0.027237558705049188,
            -0.02133375728139363,      -0.04512703228917539,      -0.043883194845277085,     -0.025044603151207545,
            -0.00021458806269304627,   0.019432545209587804,      0.027009056480791414,      0.021689601418032202,
            0.007978053529804718,      -0.006951764386240666,     -0.01656973628096208,      -0.017568142274464602,
            -0.010767118715054515,     -0.00019305987809899484,   0.009059066879413208,      0.013137258435477368,
            0.010924281837856691,      0.004176081095884903,      -0.0035915417669226614,    -0.008843251297269953,
            -0.009567841593976986,     -0.005978610069656505,     -0.0001614091629296627,    0.005057338890021917,
            0.007439466687422844,      0.006255154136374177,      0.0024345818096678097,     -0.002030662129567573,
            -0.005088839378918694,     -0.005544107115204153,     -0.003490540750129053,     -0.00012481940224640957,
            0.0029101027553914928,     0.004305916961712298,      0.0036325993682621432,     0.0014290498189259149,
            -0.00114846008412864,      -0.0029126840161716678,    -0.003177683590299736,     -0.002005264341221124,
            -0.00008861584485211762,   0.0016321613448289393,     0.002418742199839844,      0.002038853130332113,
            0.000807278380377599,      -0.0006226341547564678,    -0.0015927280535993687,    -0.0017338014198887903,
            -0.0010927092240135543,    -0.00005709423002142209,   0.0008623284546548473,     0.0012756237604383829,
            0.0010707631209802022,     0.00042517940824487083,    -0.0003136134693221922,    -0.0008066909331471724,
            -0.0008731935585711394,    -0.0005476637273956544,    -0.00003277867660879936,   0.00041600849812067334,
            0.0006120209582578663,     0.0005095886712000344,     0.00020206755938300452,    -0.00014192241084050146,
            -0.0003656295979266028,    -0.00039176291740975356,   -0.0002433524664945467,    -0.000016263122399402805,
            0.00017610155088211164,    0.00025623571397465604,    0.00021037372728432093,    0.0000827605921760652,
            -0.00005496577117692798,   -0.00014085719354295487,   -0.00014823619860910388,   -0.00009042562538399676,
            -0.000006582162075097628,  0.00006115720033477816,    0.00008706318232532724,    0.00006964410015600254,
            0.00002681912949281089,    -0.000016594762254257985,  -0.0000416318947663319,    -0.000042249293152761053,
            -0.000024787461023249072,  -0.0000018956441452944518, 0.000014888862902276953,   0.00002009178690506875,
            0.000015085719726649097,   0.00000543810810444409,    -0.0000029695790184545317, -0.000006824726676465002,
            -0.000006134974541370354,  -0.0000030954773334054167, -2.109927283343053e-7,
        };

        /// <summary>
        /// Коэффициенты, используемые для понижения частоты дискретизации в 8 раз.
        /// </summary>
        public static readonly double[] X8OversamplingCoefficients = new[]
        {
            -0.0000029200756801788613, -0.0000036908168209737206, -0.000003857741139769582,  -0.000003024682318617163,
            -8.350977788871221e-7,     0.000002944251445679728,   0.000008335743784466808,   0.000015073538480114391,
            0.000022552302392249296,   0.000029817564493604254,   0.00003561034386583803,    0.00003847317254749848,
            0.000036916791523526684,   0.000029637355104723947,   0.00001576402711344597,    -0.00000489223638045258,
            -0.000031624651137942116,  -0.00006269018410870415,   -0.00009527960921632048,   -0.00012562729555959414,
            -0.0001492767905220687,    -0.00016150026944632451,   -0.00015784871777746405,   -0.00013478758600264467,
            -0.00009035241826786288,   -0.00002474362552954989,   0.00005922797206904976,    0.0001559306580440558,
            0.00025700818217739635,    0.00035182915629416094,    0.00042829982921699437,    0.0004740073972344034,
            0.0004776147040590056,     0.0004303830392349219,     0.00032766354210853185,    0.0001701751109280932,
            -0.00003511748629931697,   -0.0002746941741945493,    -0.0005288675125380204,    -0.0007729353490468208,
            -0.0009790871554455078,    -0.0011189645274161382,    -0.0011666866444181795,    -0.0011020708694801636,
            -0.000913717654524201,     -0.0006015971096861086,    -0.00017877944581660795,   0.0003280028159593051,
            0.000879186418154025,      0.001424705435366355,      0.0019077686315023064,     0.0022698752620514185,
            0.0024566974362175017,     0.0024243167651252736,     0.002145200891163049,      0.0016132571309776188,
            0.0008473171269436378,     -0.00010750646039385977,   -0.0011809941396326742,    -0.002281711718559606,
            -0.003303548151947555,     -0.004134546766735901,     -0.004667403581060008,     -0.004810767603552248,
            -0.004500302291959165,     -0.0037083788291223272,    -0.0024512878125591514,    -0.0007929844732106322,
            0.0011553789779305066,     0.0032405457793016875,     0.005276877963377765,      0.007060273579520812,
            0.008385400398569425,      0.009064974178452884,      0.008949502590747584,      0.007945732637602508,
            0.006032006505669669,      0.0032688622142878596,     -0.00019648962673344639,   -0.004132740183272371,
            -0.008234478076064216,     -0.012139348962837467,     -0.01545147649481472,      -0.017769637713711803,
            -0.01871817944283607,      -0.01797830457696428,      -0.015317187990793525,     -0.010612425091064472,
            -0.0038695774088740088,    0.004768955023222468,      0.01502486857635727,       0.026495074986217233,
            0.03867256498462638,       0.050975771551738734,      0.06278446284949787,       0.0734796155669735,
            0.08248433887975852,       0.08930277412534568,       0.09355400202699099,       0.09499834226296974,
            0.09355400202699099,       0.08930277412534568,       0.08248433887975852,       0.0734796155669735,
            0.06278446284949787,       0.050975771551738734,      0.03867256498462638,       0.026495074986217233,
            0.01502486857635727,       0.004768955023222468,      -0.0038695774088740088,    -0.010612425091064472,
            -0.015317187990793525,     -0.01797830457696428,      -0.01871817944283607,      -0.017769637713711803,
            -0.01545147649481472,      -0.012139348962837467,     -0.008234478076064216,     -0.004132740183272371,
            -0.00019648962673344639,   0.0032688622142878596,     0.006032006505669669,      0.007945732637602508,
            0.008949502590747584,      0.009064974178452884,      0.008385400398569425,      0.007060273579520812,
            0.005276877963377765,      0.0032405457793016875,     0.0011553789779305066,     -0.0007929844732106322,
            -0.0024512878125591514,    -0.0037083788291223272,    -0.004500302291959165,     -0.004810767603552248,
            -0.004667403581060008,     -0.004134546766735901,     -0.003303548151947555,     -0.002281711718559606,
            -0.0011809941396326742,    -0.00010750646039385977,   0.0008473171269436378,     0.0016132571309776188,
            0.002145200891163049,      0.0024243167651252736,     0.0024566974362175017,     0.0022698752620514185,
            0.0019077686315023064,     0.001424705435366355,      0.000879186418154025,      0.0003280028159593051,
            -0.00017877944581660795,   -0.0006015971096861086,    -0.000913717654524201,     -0.0011020708694801636,
            -0.0011666866444181795,    -0.0011189645274161382,    -0.0009790871554455078,    -0.0007729353490468208,
            -0.0005288675125380204,    -0.0002746941741945493,    -0.00003511748629931697,   0.0001701751109280932,
            0.00032766354210853185,    0.0004303830392349219,     0.0004776147040590056,     0.0004740073972344034,
            0.00042829982921699437,    0.00035182915629416094,    0.00025700818217739635,    0.0001559306580440558,
            0.00005922797206904976,    -0.00002474362552954989,   -0.00009035241826786288,   -0.00013478758600264467,
            -0.00015784871777746405,   -0.00016150026944632451,   -0.0001492767905220687,    -0.00012562729555959414,
            -0.00009527960921632048,   -0.00006269018410870415,   -0.000031624651137942116,  -0.00000489223638045258,
            0.00001576402711344597,    0.000029637355104723947,   0.000036916791523526684,   0.00003847317254749848,
            0.00003561034386583803,    0.000029817564493604254,   0.000022552302392249296,   0.000015073538480114391,
            0.000008335743784466808,   0.000002944251445679728,   -8.350977788871221e-7,     -0.000003024682318617163,
            -0.000003857741139769582,  -0.0000036908168209737206, -0.0000029200756801788613,
        };
        
        /// <summary>
        /// Текущие коэффициенты фильтра.
        /// </summary>
        private double[] coefficients;

        /// <summary>
        /// Циклический буфер, хранящий последние n входных сэмплов.
        /// </summary>
        private double[] buffer;

        /// <summary>
        /// Указывает на индекс для записи в циклический буфер.
        /// </summary>
        private int currBufferIndex = 0;

        /// <summary>
        /// Отношение частоты дискретизации выходного сигнала к входному.
        /// </summary>
        private int order;

        /// <summary>
        /// Отношение частоты дискретизации выходного сигнала к входному.
        /// </summary>
        public int Order
        {
            get => order;
            set
            {
                order = value;
                switch (order)
                {
                    case 1:
                        break;
                    case 2:
                        coefficients = X2OversamplingCoefficients;
                        buffer = new double[coefficients.Length];
                        break;
                    case 4:
                        coefficients = X4OversamplingCoefficients;
                        buffer = new double[coefficients.Length];
                        break;
                    case 8:
                        coefficients = X8OversamplingCoefficients;
                        buffer = new double[coefficients.Length];
                        break;
                }
            }
        }

        /// <summary>
        /// Обработка новых входных данных.
        /// </summary>
        /// <param name="inputs">Массив, содержащий как минимум <see cref="Order"/> сэмплов.</param>
        /// <returns>Выходной сигнал.</returns>
        public double Process(params double[] inputs)
        {
            if (order == 1)
                return inputs[0];

            double res = 0;

            for (int inputIndex = 0; inputIndex < order; ++inputIndex)
            {
                buffer[currBufferIndex] = inputs[inputIndex];
                
                if (inputIndex == 0)
                {
                    int index = currBufferIndex;
                    for (int i = 0; i < coefficients.Length; ++i)
                    {
                        res += coefficients[i] * buffer[index];

                        index -= 1;
                        if (index < 0)
                            index = buffer.Length - 1;
                    }
                }

                currBufferIndex += 1;
                if (currBufferIndex == buffer.Length)
                    currBufferIndex = 0;
            }

            return res;
        }
    }
}
